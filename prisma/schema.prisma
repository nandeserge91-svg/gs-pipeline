// Sch√©ma de base de donn√©es pour le pipeline de commandes

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// √ânum√©ration des r√¥les utilisateurs
enum UserRole {
  ADMIN
  GESTIONNAIRE
  GESTIONNAIRE_STOCK
  APPELANT
  LIVREUR
}

// √ânum√©ration des statuts de commande
enum OrderStatus {
  NOUVELLE          // Re√ßue depuis le site
  A_APPELER         // En attente d'appel
  VALIDEE           // Client a valid√© la commande
  ANNULEE           // Client a annul√©
  INJOIGNABLE       // Client non joignable
  ASSIGNEE          // Assign√©e √† un livreur
  LIVREE            // Livr√©e avec succ√®s
  REFUSEE           // Refus√©e par le client √† la livraison
  ANNULEE_LIVRAISON // Annul√©e pendant la livraison
  RETOURNE          // Retourn√© par le livreur (client absent, etc.)
  EXPEDITION        // Paiement total 100% - Envoi vers autre ville
  EXPRESS           // Paiement partiel 10% - Retrait en agence
  EXPRESS_ARRIVE    // Colis arriv√© en agence - En attente paiement 90%
  EXPRESS_LIVRE     // Express livr√© apr√®s paiement des 90%
}

// Type de livraison pour les villes √©loign√©es
enum DeliveryType {
  LOCAL       // Livraison locale normale
  EXPEDITION  // Paiement 100% avant envoi
  EXPRESS     // Paiement 10% avant envoi, 90% √† la r√©ception
}

// Table des utilisateurs
model User {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  password  String
  nom       String
  prenom    String
  telephone String?
  role      UserRole
  actif     Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  ordersAsCaller   Order[]          @relation("CallerOrders")
  ordersAsDeliverer Order[]         @relation("DelivererOrders")
  deliveryLists       DeliveryList[]
  callStats           CallStatistic[]
  deliveryStats       DeliveryStatistic[]
  expressNotifications ExpressNotification[]
  smsLogs             SmsLog[]
  attendances         Attendance[]    // Pointages de pr√©sence

  @@map("users")
}

// Table des commandes
model Order {
  id              Int         @id @default(autoincrement())
  orderReference  String      @unique @default(uuid())
  
  // Informations client
  clientNom       String
  clientTelephone String
  clientVille     String
  clientCommune   String?
  clientAdresse   String?
  
  // Informations produit
  produitNom      String
  produitPage     String?
  productId       Int?        // Lien vers le produit (optionnel pour r√©trocompatibilit√©)
  product         Product?    @relation("ProductOrders", fields: [productId], references: [id])
  quantite        Int         @default(1)
  montant         Float
  
  // Gestion des paiements (pour EXPEDITION & EXPRESS)
  deliveryType    DeliveryType @default(LOCAL)
  montantPaye     Float?      // Montant d√©j√† pay√© (10% pour EXPRESS, 100% pour EXPEDITION)
  montantRestant  Float?      // Montant restant √† payer (90% pour EXPRESS)
  modePaiement    String?     // Mobile Money, Cash, etc.
  referencePayment String?    // R√©f√©rence de transaction Mobile Money
  
  // Informations marketing
  sourceCampagne  String?
  sourcePage      String?
  
  // Statut et pipeline
  status          OrderStatus @default(NOUVELLE)
  
  // Assignations
  callerId        Int?
  caller          User?       @relation("CallerOrders", fields: [callerId], references: [id])
  calledAt        DateTime?
  
  delivererId     Int?
  deliverer       User?       @relation("DelivererOrders", fields: [delivererId], references: [id])
  deliveryDate    DateTime?
  deliveryListId  Int?
  deliveryList    DeliveryList? @relation(fields: [deliveryListId], references: [id])
  
  // Notes internes
  noteAppelant    String?
  noteLivreur     String?
  noteGestionnaire String?
  
  // Gestion des retours
  raisonRetour    String?     // Raison du retour (client absent, refuse, adresse incorrecte, etc.)
  retourneAt      DateTime?   // Date du retour
  
  // Gestion EXPEDITION - Code de suivi
  codeExpedition  String?     // Code d'exp√©dition/tracking fourni par le livreur
  photoRecuExpedition String? // Photo du re√ßu d'exp√©dition (base64 ou URL)
  photoRecuExpeditionUploadedAt DateTime? // Date d'upload de la photo (pour suppression auto apr√®s 7j)
  
  // Gestion EXPRESS - Notification d'arriv√©e
  clientNotifie   Boolean?    @default(false) // Client notifi√© de l'arriv√©e du colis
  notifieAt       DateTime?   // Date de notification du client
  notifiePar      Int?        // Appelant qui a notifi√©
  agenceRetrait   String?     // Nom de l'agence de retrait
  
  // Statut paiement EXPEDITION
  enAttentePaiement Boolean    @default(false)  // Commande en attente de paiement (pour EXPEDITION)
  attentePaiementAt DateTime?  // Date de mise en attente de paiement
  
  // Gestion des RDV (Rendez-vous pour rappel)
  rdvProgramme    Boolean     @default(false)  // RDV programm√© pour rappeler le client
  rdvDate         DateTime?   // Date et heure du RDV
  rdvNote         String?     // Note sur le RDV (client occup√©, en voyage, etc.)
  rdvProgrammePar Int?        // ID de l'appelant qui a programm√© le RDV
  rdvRappele      Boolean     @default(false)  // RDV trait√© (client rappel√©)
  
  // Priorisation "√Ä appeler" (pour tri intelligent)
  renvoyeAAppelerAt DateTime?  // Date de renvoi vers "√Ä appeler" (pour affichage prioritaire en haut)
  
  // Dates de suivi
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  validatedAt     DateTime?
  deliveredAt     DateTime?
  expedieAt       DateTime?   // Date d'exp√©dition (pour EXPEDITION et EXPRESS)
  arriveAt        DateTime?   // Date d'arriv√©e en agence (pour EXPRESS)
  
  // Historique des changements de statut
  statusHistory        StatusHistory[]
  
  // Notifications EXPRESS
  expressNotifications ExpressNotification[]
  
  // SMS envoy√©s pour cette commande
  smsLogs              SmsLog[]

  @@map("orders")
  @@index([status])
  @@index([clientTelephone])
  @@index([clientVille])
  @@index([deliveryDate])
  @@index([callerId])
  @@index([delivererId])
}

// Historique des changements de statut
model StatusHistory {
  id        Int         @id @default(autoincrement())
  orderId   Int
  order     Order       @relation(fields: [orderId], references: [id], onDelete: Cascade)
  oldStatus OrderStatus?
  newStatus OrderStatus
  changedBy Int
  comment   String?
  createdAt DateTime    @default(now())

  @@map("status_history")
  @@index([orderId])
}

// Listes de livraison journali√®res
model DeliveryList {
  id           Int      @id @default(autoincrement())
  nom          String
  date         DateTime
  delivererId  Int
  deliverer    User     @relation(fields: [delivererId], references: [id])
  zone         String?  // Zone g√©ographique
  orders       Order[]
  tourneeStock TourneeStock? // Lien avec la gestion de stock
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("delivery_lists")
  @@index([delivererId, date])
}

// Statistiques d'appels (pour les appelants)
model CallStatistic {
  id                Int      @id @default(autoincrement())
  userId            Int
  user              User     @relation(fields: [userId], references: [id])
  date              DateTime @default(now())
  
  totalAppels       Int      @default(0)
  totalValides      Int      @default(0)
  totalAnnules      Int      @default(0)
  totalInjoignables Int      @default(0)
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@map("call_statistics")
  @@index([userId, date])
}

// Statistiques de livraison (pour les livreurs)
model DeliveryStatistic {
  id               Int      @id @default(autoincrement())
  userId           Int
  user             User     @relation(fields: [userId], references: [id])
  date             DateTime @default(now())
  
  totalLivraisons  Int      @default(0)
  totalRefusees    Int      @default(0)
  totalAnnulees    Int      @default(0)
  montantLivre     Float    @default(0)
  
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@map("delivery_statistics")
  @@index([userId, date])
}

// Notifications pour les EXPRESS en agence
model ExpressNotification {
  id          Int      @id @default(autoincrement())
  orderId     Int
  order       Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  userId      Int      // Appelant qui a notifi√©
  user        User     @relation(fields: [userId], references: [id])
  note        String?  // Raison du non-retrait (occup√©, voyage, etc.)
  notifiedAt  DateTime @default(now())

  @@map("express_notifications")
  @@index([orderId])
  @@index([userId])
}

// ========================================
// NOUVEAU : GESTION DE STOCK
// ========================================

// Table des produits
model Product {
  id           Int      @id @default(autoincrement())
  code         String   @unique  // Code/r√©f√©rence produit
  nom          String
  description  String?
  prixUnitaire Float    // Prix par d√©faut (si pas de prix par quantit√©)
  prix1        Float?   // Prix pour 1 unit√©
  prix2        Float?   // Prix pour 2 unit√©s
  prix3        Float?   // Prix pour 3 unit√©s ou plus
  stockActuel  Int      @default(0)  // Stock disponible normal
  stockExpress Int      @default(0)  // Stock r√©serv√© EXPRESS (pay√© 10%, en attente retrait)
  stockAlerte  Int      @default(10) // Seuil d'alerte
  actif        Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  stockMovements StockMovement[]
  orders         Order[]          @relation("ProductOrders")

  @@map("products")
  @@index([code])
  @@index([actif])
}

// Types de mouvements de stock
enum StockMovementType {
  APPROVISIONNEMENT     // Ajout de stock manuel par admin
  LIVRAISON            // Sortie de stock (commande livr√©e)
  RETOUR               // Retour de colis non livr√©
  CORRECTION           // Correction manuelle
  PERTE                // Perte/casse
  RESERVATION          // R√©servation stock pour EXP√âDITION (100% pay√©)
  RESERVATION_EXPRESS  // D√©placement vers stock EXPRESS (10% pay√©)
  RETRAIT_EXPRESS      // Sortie du stock EXPRESS (client a retir√©)
  ANNULATION_EXPRESS   // Annulation EXPRESS, retour au stock normal
}

// Mouvements de stock (entr√©es/sorties)
model StockMovement {
  id          Int               @id @default(autoincrement())
  productId   Int
  product     Product           @relation(fields: [productId], references: [id])
  
  type        StockMovementType
  quantite    Int               // Positif pour entr√©e, n√©gatif pour sortie
  stockAvant  Int               // Stock avant le mouvement
  stockApres  Int               // Stock apr√®s le mouvement
  
  // R√©f√©rences optionnelles
  orderId     Int?              // Si li√© √† une commande
  tourneeId   Int?              // Si li√© √† une tourn√©e
  tournee     TourneeStock?     @relation(fields: [tourneeId], references: [id])
  
  effectuePar Int               // User qui a effectu√© le mouvement
  motif       String?           // Raison du mouvement
  
  createdAt   DateTime          @default(now())

  @@map("stock_movements")
  @@index([productId])
  @@index([type])
  @@index([createdAt])
  @@index([tourneeId])
}

// Gestion des tourn√©es c√¥t√© stock (colis remis/retourn√©s)
model TourneeStock {
  id                    Int      @id @default(autoincrement())
  deliveryListId        Int      @unique
  deliveryList          DeliveryList @relation(fields: [deliveryListId], references: [id])
  
  // Colis remis au d√©part
  colisRemis            Int      @default(0)
  colisRemisConfirme    Boolean  @default(false)
  colisRemisAt          DateTime?
  colisRemisBy          Int?     // Gestionnaire de stock qui a confirm√©
  
  // Retour apr√®s tourn√©e
  colisLivres           Int      @default(0) // Calcul√© automatiquement depuis les commandes
  colisRetour           Int      @default(0)
  colisRetourConfirme   Boolean  @default(false)
  colisRetourAt         DateTime?
  colisRetourBy         Int?     // Gestionnaire de stock qui a enregistr√©
  
  // V√©rification
  ecart                 Int      @default(0) // colisRemis - (colisLivres + colisRetour)
  ecartResolu           Boolean  @default(false)
  ecartMotif            String?  // Explication si √©cart (perte, casse, etc.)
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  // Relations
  stockMovements        StockMovement[]

  @@map("tournees_stock")
  @@index([deliveryListId])
  @@index([colisRemisConfirme])
  @@index([colisRetourConfirme])
}

// ========================================
// NOUVEAU : GESTION SMS
// ========================================

// Statut d'envoi SMS
enum SmsStatus {
  SENT    // Envoy√© avec succ√®s
  FAILED  // √âchec d'envoi
  PENDING // En attente
}

// Type de SMS
enum SmsType {
  NOTIFICATION       // Notification g√©n√©rale
  ORDER_CREATED      // Commande cr√©√©e
  ORDER_VALIDATED    // Commande valid√©e
  DELIVERY_ASSIGNED  // Livreur assign√©
  ORDER_DELIVERED    // Commande livr√©e
  EXPEDITION         // Exp√©dition confirm√©e
  EXPRESS_ARRIVED    // EXPRESS arriv√© en agence
  EXPRESS_REMINDER   // Rappel retrait EXPRESS
  RDV_SCHEDULED      // RDV programm√©
  RDV_REMINDER       // Rappel RDV
  ALERT              // Alerte interne
}

// Table des logs SMS
model SmsLog {
  id            Int       @id @default(autoincrement())
  phoneNumber   String    // Num√©ro destinataire
  message       String    // Message envoy√©
  status        SmsStatus @default(PENDING)
  provider      String    @default("SMS8") // Fournisseur (SMS8, Twilio, etc.)
  providerId    String?   // ID du message chez le fournisseur
  errorMessage  String?   // Message d'erreur si √©chec
  
  // Relations
  orderId       Int?      // Commande li√©e (optionnel)
  order         Order?    @relation(fields: [orderId], references: [id], onDelete: SetNull)
  userId        Int?      // Utilisateur li√© (optionnel)
  user          User?     @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  type          SmsType   @default(NOTIFICATION)
  credits       Int?      // Cr√©dits restants apr√®s envoi
  
  sentAt        DateTime  @default(now())
  
  @@map("sms_logs")
  @@index([orderId])
  @@index([userId])
  @@index([status])
  @@index([type])
  @@index([sentAt])
  @@index([phoneNumber])
}

// Templates SMS personnalisables
model SmsTemplate {
  id                Int       @id @default(autoincrement())
  key               String    @unique  // Cl√© unique (ORDER_CREATED, ORDER_VALIDATED, etc.)
  label             String    // Nom affich√©
  description       String    // Description du template
  category          String    // Cat√©gorie (Commandes, Livraison, Exp√©dition, etc.)
  icon              String    // Ic√¥ne emoji
  
  template          String    // Template personnalis√© (avec variables)
  defaultTemplate   String    // Template par d√©faut (pour reset)
  variables         String    // Variables disponibles au format JSON (ex: ["prenom", "ref", "montant"])
  
  characterCount    Int       @default(0)  // Nombre de caract√®res du template
  isActive          Boolean   @default(true)
  
  lastModifiedAt    DateTime  @updatedAt
  lastModifiedBy    Int?      // User qui a modifi√© en dernier
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  @@map("sms_templates")
  @@index([key])
  @@index([category])
}

// üìç SYST√àME DE POINTAGE G√âOLOCALIS√â

// Table de pointage des pr√©sences
model Attendance {
  id                Int       @id @default(autoincrement())
  userId            Int
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Date et heures
  date              DateTime  @db.Date
  heureArrivee      DateTime  @default(now())
  heureDepart       DateTime?
  
  // G√©olocalisation arriv√©e
  latitudeArrivee   Float
  longitudeArrivee  Float
  distanceArrivee   Float     // Distance en m√®tres du magasin
  
  // G√©olocalisation d√©part (optionnel)
  latitudeDepart    Float?
  longitudeDepart   Float?
  distanceDepart    Float?
  
  // Validation
  validee           Boolean   @default(false)
  validation        String?   // "VALIDE", "HORS_ZONE", "RETARD"
  
  // Informations suppl√©mentaires
  note              String?
  ipAddress         String?
  deviceInfo        String?   @db.Text
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  @@unique([userId, date])  // Un seul pointage par personne par jour
  @@map("attendances")
  @@index([userId])
  @@index([date])
  @@index([validee])
  @@index([validation])
}

// Configuration du magasin (coordonn√©es GPS et param√®tres)
model StoreConfig {
  id                Int       @id @default(autoincrement())
  nom               String    @default("Magasin Principal")
  adresse           String?
  
  // Coordonn√©es GPS du magasin
  latitude          Float     // Ex: 5.3599517 (Abidjan, C√¥te d'Ivoire)
  longitude         Float     // Ex: -4.0082563
  
  // Rayon de tol√©rance (en m√®tres)
  rayonTolerance    Int       @default(50)  // 50 m√®tres par d√©faut
  
  // Horaires de travail
  heureOuverture    String    @default("08:00")
  heureFermeture    String    @default("18:00")
  
  // Tol√©rance de retard (en minutes)
  toleranceRetard   Int       @default(15)  // 15 minutes
  
  // Jours ouvr√©s (format JSON: ["lundi", "mardi", ...])
  joursOuvres       String    @default("[\"lundi\",\"mardi\",\"mercredi\",\"jeudi\",\"vendredi\",\"samedi\"]") @db.Text
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  @@map("store_config")
}

