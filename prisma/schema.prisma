// Schéma de base de données pour le pipeline de commandes

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Énumération des rôles utilisateurs
enum UserRole {
  ADMIN
  GESTIONNAIRE
  GESTIONNAIRE_STOCK
  APPELANT
  LIVREUR
}

// Énumération des statuts de commande
enum OrderStatus {
  NOUVELLE          // Reçue depuis le site
  A_APPELER         // En attente d'appel
  VALIDEE           // Client a validé la commande
  ANNULEE           // Client a annulé
  INJOIGNABLE       // Client non joignable
  ASSIGNEE          // Assignée à un livreur
  LIVREE            // Livrée avec succès
  REFUSEE           // Refusée par le client à la livraison
  ANNULEE_LIVRAISON // Annulée pendant la livraison
  RETOURNE          // Retourné par le livreur (client absent, etc.)
  EXPEDITION        // Paiement total 100% - Envoi vers autre ville
  EXPRESS           // Paiement partiel 10% - Retrait en agence
  EXPRESS_ARRIVE    // Colis arrivé en agence - En attente paiement 90%
  EXPRESS_LIVRE     // Express livré après paiement des 90%
}

// Type de livraison pour les villes éloignées
enum DeliveryType {
  LOCAL       // Livraison locale normale
  EXPEDITION  // Paiement 100% avant envoi
  EXPRESS     // Paiement 10% avant envoi, 90% à la réception
}

// Table des utilisateurs
model User {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  password  String
  nom       String
  prenom    String
  telephone String?
  role      UserRole
  actif     Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  ordersAsCaller   Order[]          @relation("CallerOrders")
  ordersAsDeliverer Order[]         @relation("DelivererOrders")
  deliveryLists       DeliveryList[]
  callStats           CallStatistic[]
  deliveryStats       DeliveryStatistic[]
  expressNotifications ExpressNotification[]
  smsLogs             SmsLog[]

  @@map("users")
}

// Table des commandes
model Order {
  id              Int         @id @default(autoincrement())
  orderReference  String      @unique @default(uuid())
  
  // Informations client
  clientNom       String
  clientTelephone String
  clientVille     String
  clientCommune   String?
  clientAdresse   String?
  
  // Informations produit
  produitNom      String
  produitPage     String?
  productId       Int?        // Lien vers le produit (optionnel pour rétrocompatibilité)
  product         Product?    @relation("ProductOrders", fields: [productId], references: [id])
  quantite        Int         @default(1)
  montant         Float
  
  // Gestion des paiements (pour EXPEDITION & EXPRESS)
  deliveryType    DeliveryType @default(LOCAL)
  montantPaye     Float?      // Montant déjà payé (10% pour EXPRESS, 100% pour EXPEDITION)
  montantRestant  Float?      // Montant restant à payer (90% pour EXPRESS)
  modePaiement    String?     // Mobile Money, Cash, etc.
  referencePayment String?    // Référence de transaction Mobile Money
  
  // Informations marketing
  sourceCampagne  String?
  sourcePage      String?
  
  // Statut et pipeline
  status          OrderStatus @default(NOUVELLE)
  
  // Assignations
  callerId        Int?
  caller          User?       @relation("CallerOrders", fields: [callerId], references: [id])
  calledAt        DateTime?
  
  delivererId     Int?
  deliverer       User?       @relation("DelivererOrders", fields: [delivererId], references: [id])
  deliveryDate    DateTime?
  deliveryListId  Int?
  deliveryList    DeliveryList? @relation(fields: [deliveryListId], references: [id])
  
  // Notes internes
  noteAppelant    String?
  noteLivreur     String?
  noteGestionnaire String?
  
  // Gestion des retours
  raisonRetour    String?     // Raison du retour (client absent, refuse, adresse incorrecte, etc.)
  retourneAt      DateTime?   // Date du retour
  
  // Gestion EXPEDITION - Code de suivi
  codeExpedition  String?     // Code d'expédition/tracking fourni par le livreur
  photoRecuExpedition String? // Photo du reçu d'expédition (base64 ou URL)
  photoRecuExpeditionUploadedAt DateTime? // Date d'upload de la photo (pour suppression auto après 7j)
  
  // Gestion EXPRESS - Notification d'arrivée
  clientNotifie   Boolean?    @default(false) // Client notifié de l'arrivée du colis
  notifieAt       DateTime?   // Date de notification du client
  notifiePar      Int?        // Appelant qui a notifié
  agenceRetrait   String?     // Nom de l'agence de retrait
  
  // Statut paiement EXPEDITION
  enAttentePaiement Boolean    @default(false)  // Commande en attente de paiement (pour EXPEDITION)
  attentePaiementAt DateTime?  // Date de mise en attente de paiement
  
  // Gestion des RDV (Rendez-vous pour rappel)
  rdvProgramme    Boolean     @default(false)  // RDV programmé pour rappeler le client
  rdvDate         DateTime?   // Date et heure du RDV
  rdvNote         String?     // Note sur le RDV (client occupé, en voyage, etc.)
  rdvProgrammePar Int?        // ID de l'appelant qui a programmé le RDV
  rdvRappele      Boolean     @default(false)  // RDV traité (client rappelé)
  
  // Dates de suivi
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  validatedAt     DateTime?
  deliveredAt     DateTime?
  expedieAt       DateTime?   // Date d'expédition (pour EXPEDITION et EXPRESS)
  arriveAt        DateTime?   // Date d'arrivée en agence (pour EXPRESS)
  
  // Historique des changements de statut
  statusHistory        StatusHistory[]
  
  // Notifications EXPRESS
  expressNotifications ExpressNotification[]
  
  // SMS envoyés pour cette commande
  smsLogs              SmsLog[]

  @@map("orders")
  @@index([status])
  @@index([clientTelephone])
  @@index([clientVille])
  @@index([deliveryDate])
  @@index([callerId])
  @@index([delivererId])
}

// Historique des changements de statut
model StatusHistory {
  id        Int         @id @default(autoincrement())
  orderId   Int
  order     Order       @relation(fields: [orderId], references: [id], onDelete: Cascade)
  oldStatus OrderStatus?
  newStatus OrderStatus
  changedBy Int
  comment   String?
  createdAt DateTime    @default(now())

  @@map("status_history")
  @@index([orderId])
}

// Listes de livraison journalières
model DeliveryList {
  id           Int      @id @default(autoincrement())
  nom          String
  date         DateTime
  delivererId  Int
  deliverer    User     @relation(fields: [delivererId], references: [id])
  zone         String?  // Zone géographique
  orders       Order[]
  tourneeStock TourneeStock? // Lien avec la gestion de stock
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("delivery_lists")
  @@index([delivererId, date])
}

// Statistiques d'appels (pour les appelants)
model CallStatistic {
  id                Int      @id @default(autoincrement())
  userId            Int
  user              User     @relation(fields: [userId], references: [id])
  date              DateTime @default(now())
  
  totalAppels       Int      @default(0)
  totalValides      Int      @default(0)
  totalAnnules      Int      @default(0)
  totalInjoignables Int      @default(0)
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@map("call_statistics")
  @@index([userId, date])
}

// Statistiques de livraison (pour les livreurs)
model DeliveryStatistic {
  id               Int      @id @default(autoincrement())
  userId           Int
  user             User     @relation(fields: [userId], references: [id])
  date             DateTime @default(now())
  
  totalLivraisons  Int      @default(0)
  totalRefusees    Int      @default(0)
  totalAnnulees    Int      @default(0)
  montantLivre     Float    @default(0)
  
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@map("delivery_statistics")
  @@index([userId, date])
}

// Notifications pour les EXPRESS en agence
model ExpressNotification {
  id          Int      @id @default(autoincrement())
  orderId     Int
  order       Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  userId      Int      // Appelant qui a notifié
  user        User     @relation(fields: [userId], references: [id])
  note        String?  // Raison du non-retrait (occupé, voyage, etc.)
  notifiedAt  DateTime @default(now())

  @@map("express_notifications")
  @@index([orderId])
  @@index([userId])
}

// ========================================
// NOUVEAU : GESTION DE STOCK
// ========================================

// Table des produits
model Product {
  id           Int      @id @default(autoincrement())
  code         String   @unique  // Code/référence produit
  nom          String
  description  String?
  prixUnitaire Float    // Prix par défaut (si pas de prix par quantité)
  prix1        Float?   // Prix pour 1 unité
  prix2        Float?   // Prix pour 2 unités
  prix3        Float?   // Prix pour 3 unités ou plus
  stockActuel  Int      @default(0)  // Stock disponible normal
  stockExpress Int      @default(0)  // Stock réservé EXPRESS (payé 10%, en attente retrait)
  stockAlerte  Int      @default(10) // Seuil d'alerte
  actif        Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  stockMovements StockMovement[]
  orders         Order[]          @relation("ProductOrders")

  @@map("products")
  @@index([code])
  @@index([actif])
}

// Types de mouvements de stock
enum StockMovementType {
  APPROVISIONNEMENT     // Ajout de stock manuel par admin
  LIVRAISON            // Sortie de stock (commande livrée)
  RETOUR               // Retour de colis non livré
  CORRECTION           // Correction manuelle
  PERTE                // Perte/casse
  RESERVATION          // Réservation stock pour EXPÉDITION (100% payé)
  RESERVATION_EXPRESS  // Déplacement vers stock EXPRESS (10% payé)
  RETRAIT_EXPRESS      // Sortie du stock EXPRESS (client a retiré)
  ANNULATION_EXPRESS   // Annulation EXPRESS, retour au stock normal
}

// Mouvements de stock (entrées/sorties)
model StockMovement {
  id          Int               @id @default(autoincrement())
  productId   Int
  product     Product           @relation(fields: [productId], references: [id])
  
  type        StockMovementType
  quantite    Int               // Positif pour entrée, négatif pour sortie
  stockAvant  Int               // Stock avant le mouvement
  stockApres  Int               // Stock après le mouvement
  
  // Références optionnelles
  orderId     Int?              // Si lié à une commande
  tourneeId   Int?              // Si lié à une tournée
  tournee     TourneeStock?     @relation(fields: [tourneeId], references: [id])
  
  effectuePar Int               // User qui a effectué le mouvement
  motif       String?           // Raison du mouvement
  
  createdAt   DateTime          @default(now())

  @@map("stock_movements")
  @@index([productId])
  @@index([type])
  @@index([createdAt])
  @@index([tourneeId])
}

// Gestion des tournées côté stock (colis remis/retournés)
model TourneeStock {
  id                    Int      @id @default(autoincrement())
  deliveryListId        Int      @unique
  deliveryList          DeliveryList @relation(fields: [deliveryListId], references: [id])
  
  // Colis remis au départ
  colisRemis            Int      @default(0)
  colisRemisConfirme    Boolean  @default(false)
  colisRemisAt          DateTime?
  colisRemisBy          Int?     // Gestionnaire de stock qui a confirmé
  
  // Retour après tournée
  colisLivres           Int      @default(0) // Calculé automatiquement depuis les commandes
  colisRetour           Int      @default(0)
  colisRetourConfirme   Boolean  @default(false)
  colisRetourAt         DateTime?
  colisRetourBy         Int?     // Gestionnaire de stock qui a enregistré
  
  // Vérification
  ecart                 Int      @default(0) // colisRemis - (colisLivres + colisRetour)
  ecartResolu           Boolean  @default(false)
  ecartMotif            String?  // Explication si écart (perte, casse, etc.)
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  // Relations
  stockMovements        StockMovement[]

  @@map("tournees_stock")
  @@index([deliveryListId])
  @@index([colisRemisConfirme])
  @@index([colisRetourConfirme])
}

// ========================================
// NOUVEAU : GESTION SMS
// ========================================

// Statut d'envoi SMS
enum SmsStatus {
  SENT    // Envoyé avec succès
  FAILED  // Échec d'envoi
  PENDING // En attente
}

// Type de SMS
enum SmsType {
  NOTIFICATION       // Notification générale
  ORDER_CREATED      // Commande créée
  ORDER_VALIDATED    // Commande validée
  DELIVERY_ASSIGNED  // Livreur assigné
  ORDER_DELIVERED    // Commande livrée
  EXPEDITION         // Expédition confirmée
  EXPRESS_ARRIVED    // EXPRESS arrivé en agence
  EXPRESS_REMINDER   // Rappel retrait EXPRESS
  RDV_SCHEDULED      // RDV programmé
  RDV_REMINDER       // Rappel RDV
  ALERT              // Alerte interne
}

// Table des logs SMS
model SmsLog {
  id            Int       @id @default(autoincrement())
  phoneNumber   String    // Numéro destinataire
  message       String    // Message envoyé
  status        SmsStatus @default(PENDING)
  provider      String    @default("SMS8") // Fournisseur (SMS8, Twilio, etc.)
  providerId    String?   // ID du message chez le fournisseur
  errorMessage  String?   // Message d'erreur si échec
  
  // Relations
  orderId       Int?      // Commande liée (optionnel)
  order         Order?    @relation(fields: [orderId], references: [id], onDelete: SetNull)
  userId        Int?      // Utilisateur lié (optionnel)
  user          User?     @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  type          SmsType   @default(NOTIFICATION)
  credits       Int?      // Crédits restants après envoi
  
  sentAt        DateTime  @default(now())
  
  @@map("sms_logs")
  @@index([orderId])
  @@index([userId])
  @@index([status])
  @@index([type])
  @@index([sentAt])
  @@index([phoneNumber])
}

// Templates SMS personnalisables
model SmsTemplate {
  id                Int       @id @default(autoincrement())
  key               String    @unique  // Clé unique (ORDER_CREATED, ORDER_VALIDATED, etc.)
  label             String    // Nom affiché
  description       String    // Description du template
  category          String    // Catégorie (Commandes, Livraison, Expédition, etc.)
  icon              String    // Icône emoji
  
  template          String    // Template personnalisé (avec variables)
  defaultTemplate   String    // Template par défaut (pour reset)
  variables         String    // Variables disponibles au format JSON (ex: ["prenom", "ref", "montant"])
  
  characterCount    Int       @default(0)  // Nombre de caractères du template
  isActive          Boolean   @default(true)
  
  lastModifiedAt    DateTime  @updatedAt
  lastModifiedBy    Int?      // User qui a modifié en dernier
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  @@map("sms_templates")
  @@index([key])
  @@index([category])
}

